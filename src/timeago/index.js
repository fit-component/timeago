"use strict";
const React = require('react');
const moment = require('moment');
class Timeago extends React.Component {
    constructor(props) {
        super(props);
        this.state = {};
    }
    componentWillMount() {
        this._isMounted = true;
        this.timeoutId = 0;
    }
    componentDidMount() {
        if (this.props.live) {
            this.tick(true);
        }
    }
    componentDidUpdate(nextProps) {
        if (this.props.live !== nextProps.live || this.props.date !== nextProps.date) {
            if (!this.props.live && this.timeoutId) {
                clearTimeout(this.timeoutId);
                this.timeoutId = undefined;
            }
            this.tick();
        }
    }
    componentWillUnmount() {
        this._isMounted = false;
        if (this.timeoutId) {
            clearTimeout(this.timeoutId);
            this.timeoutId = undefined;
        }
    }
    tick(refresh) {
        if (!this._isMounted || !this.props.live) {
            return;
        }
        let period = 1000;
        let then = (new Date(this.props.date)).valueOf();
        let now = Date.now();
        let seconds = Math.round(Math.abs(now - then) / 1000);
        if (seconds < 60) {
            period = 1000;
        }
        else if (seconds < 60 * 60) {
            period = 1000 * 60;
        }
        else if (seconds < 60 * 60 * 24) {
            period = 1000 * 60 * 60;
        }
        else {
            period = 0;
        }
        period = Math.min(Math.max(period, this.props.minPeriod), this.props.maxPeriod);
        if (!!period) {
            this.timeoutId = setTimeout(() => {
                this.tick();
            }, period);
        }
        if (!refresh) {
            this.forceUpdate();
        }
    }
    render() {
        let { component, date, loseTime, loseFormat, label, formatter } = this.props;
        let then = (new Date(date)).valueOf();
        let now = Date.now();
        if (now - then >= loseTime) {
            let fullDate = moment(date);
            let formatString = fullDate.format(loseFormat);
            return React.createElement(component, null, formatString);
        }
        else {
            let seconds = Math.round(Math.abs(now - then) / 1000);
            let suffix = then < now ? label.ago : label.fromNow;
            let value, unit;
            if (seconds < 60) {
                value = Math.round(seconds);
                unit = label.second;
            }
            else if (seconds < 60 * 60) {
                value = Math.round(seconds / 60);
                unit = label.minute;
            }
            else if (seconds < 60 * 60 * 24) {
                value = Math.round(seconds / (60 * 60));
                unit = label.hour;
            }
            else if (seconds < 60 * 60 * 24 * 7) {
                value = Math.round(seconds / (60 * 60 * 24));
                unit = label.day;
            }
            else if (seconds < 60 * 60 * 24 * 30) {
                value = Math.round(seconds / (60 * 60 * 24 * 7));
                unit = label.week;
            }
            else if (seconds < 60 * 60 * 24 * 365) {
                value = Math.round(seconds / (60 * 60 * 24 * 30));
                unit = label.month;
            }
            else {
                value = Math.round(seconds / (60 * 60 * 24 * 365));
                unit = label.year;
            }
            let fullDate = moment(date);
            let newProps = Object.assign({}, null, {
                title: fullDate.format(loseFormat)
            });
            return React.createElement(component, newProps, formatter(value, unit, suffix, then));
        }
    }
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = Timeago;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUVBLE1BQVksS0FBSyxXQUFNLE9BQ3ZCLENBQUMsQ0FENkI7QUFDOUIsTUFBWSxNQUFNLFdBQU0sUUFDeEIsQ0FBQyxDQUQrQjtBQUdoQyxzQkFBcUMsS0FBSyxDQUFDLFNBQVM7SUFLaEQsWUFBWSxLQUFnQztRQUN4QyxNQUFNLEtBQUssQ0FBQyxDQUFBO1FBQ1osSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUE7SUFDbkIsQ0FBQztJQUVTLGtCQUFrQjtRQUN4QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQTtRQUN0QixJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQTtJQUN0QixDQUFDO0lBRVMsaUJBQWlCO1FBQ3ZCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNsQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ25CLENBQUM7SUFDTCxDQUFDO0lBRVMsa0JBQWtCLENBQUMsU0FBb0M7UUFDN0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMzRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxZQUFZLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO2dCQUM1QixJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQTtZQUM5QixDQUFDO1lBQ0QsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFBO1FBQ2YsQ0FBQztJQUNMLENBQUM7SUFF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QUFDLEVBQUUsRUFBRSxJQUFJLEVBQUU7Z0JBQ25DLEtBQUssRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQzthQUNyQyxDQUFDLENBQUE7WUFFRixNQUFNLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFBO1FBQ3pGLENBQUM7SUFDTCxDQUFDO0FBQ0wsQ0FBQztBQXhIRDt5QkF3SEMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi8uLi8uLi90eXBpbmdzL3RzZC5kLnRzXCIgLz5cblxuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgKiBhcyBtb21lbnQgZnJvbSAnbW9tZW50J1xuaW1wb3J0ICogYXMgTW9kdWxlIGZyb20gJy4vbW9kdWxlJ1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUaW1lYWdvIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PE1vZHVsZS5UaW1lYWdvTW9kdWxlLlByb3BzLCBNb2R1bGUuVGltZWFnb01vZHVsZS5TdGF0ZT4ge1xuICAgIF9pc01vdW50ZWQ6Ym9vbGVhblxuICAgIHRpbWVvdXRJZDpudW1iZXJcbiAgICBzdGF0aWMgZGVmYXVsdFByb3BzOk1vZHVsZS5UaW1lYWdvTW9kdWxlLlByb3BzXG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczpNb2R1bGUuVGltZWFnb01vZHVsZS5Qcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcylcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHt9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGNvbXBvbmVudFdpbGxNb3VudCgpOnZvaWQge1xuICAgICAgICB0aGlzLl9pc01vdW50ZWQgPSB0cnVlXG4gICAgICAgIHRoaXMudGltZW91dElkID0gMFxuICAgIH1cblxuICAgIHByb3RlY3RlZCBjb21wb25lbnREaWRNb3VudCgpOnZvaWQge1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5saXZlKSB7XG4gICAgICAgICAgICB0aGlzLnRpY2sodHJ1ZSlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBjb21wb25lbnREaWRVcGRhdGUobmV4dFByb3BzOk1vZHVsZS5UaW1lYWdvTW9kdWxlLlByb3BzKTp2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMubGl2ZSAhPT0gbmV4dFByb3BzLmxpdmUgfHwgdGhpcy5wcm9wcy5kYXRlICE9PSBuZXh0UHJvcHMuZGF0ZSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLnByb3BzLmxpdmUgJiYgdGhpcy50aW1lb3V0SWQpIHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SWQpXG4gICAgICAgICAgICAgICAgdGhpcy50aW1lb3V0SWQgPSB1bmRlZmluZWRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMudGljaygpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY29tcG9uZW50V2lsbFVubW91bnQoKTp2b2lkIHtcbiAgICAgICAgdGhpcy5faXNNb3VudGVkID0gZmFsc2VcbiAgICAgICAgaWYgKHRoaXMudGltZW91dElkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SWQpXG4gICAgICAgICAgICB0aGlzLnRpbWVvdXRJZCA9IHVuZGVmaW5lZFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0aWNrKHJlZnJlc2g/OmJvb2xlYW4pOnZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuX2lzTW91bnRlZCB8fCAhdGhpcy5wcm9wcy5saXZlKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBwZXJpb2QgPSAxMDAwXG5cbiAgICAgICAgbGV0IHRoZW4gPSAobmV3IERhdGUodGhpcy5wcm9wcy5kYXRlKSkudmFsdWVPZigpXG4gICAgICAgIGxldCBub3cgPSBEYXRlLm5vdygpXG4gICAgICAgIGxldCBzZWNvbmRzID0gTWF0aC5yb3VuZChNYXRoLmFicyhub3cgLSB0aGVuKSAvIDEwMDApXG5cbiAgICAgICAgaWYgKHNlY29uZHMgPCA2MCkge1xuICAgICAgICAgICAgcGVyaW9kID0gMTAwMFxuICAgICAgICB9IGVsc2UgaWYgKHNlY29uZHMgPCA2MCAqIDYwKSB7XG4gICAgICAgICAgICBwZXJpb2QgPSAxMDAwICogNjBcbiAgICAgICAgfSBlbHNlIGlmIChzZWNvbmRzIDwgNjAgKiA2MCAqIDI0KSB7XG4gICAgICAgICAgICBwZXJpb2QgPSAxMDAwICogNjAgKiA2MFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGVyaW9kID0gMFxuICAgICAgICB9XG5cbiAgICAgICAgcGVyaW9kID0gTWF0aC5taW4oTWF0aC5tYXgocGVyaW9kLCB0aGlzLnByb3BzLm1pblBlcmlvZCksIHRoaXMucHJvcHMubWF4UGVyaW9kKVxuXG4gICAgICAgIGlmICghIXBlcmlvZCkge1xuICAgICAgICAgICAgdGhpcy50aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMudGljaygpXG4gICAgICAgICAgICB9LCBwZXJpb2QpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXJlZnJlc2gpIHtcbiAgICAgICAgICAgIHRoaXMuZm9yY2VVcGRhdGUoKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlcigpOlJlYWN0LlJlYWN0RWxlbWVudDxhbnk+IHtcbiAgICAgICAgbGV0IHtjb21wb25lbnQsIGRhdGUsIGxvc2VUaW1lLCBsb3NlRm9ybWF0LCBsYWJlbCwgZm9ybWF0dGVyfSA9IHRoaXMucHJvcHNcblxuICAgICAgICBsZXQgdGhlbiA9IChuZXcgRGF0ZShkYXRlKSkudmFsdWVPZigpXG4gICAgICAgIGxldCBub3cgPSBEYXRlLm5vdygpXG5cbiAgICAgICAgaWYgKG5vdyAtIHRoZW4gPj0gbG9zZVRpbWUpIHsgLy8g5Y+L5aW95pe26Ze05aSx5pWI5LqGXG4gICAgICAgICAgICBsZXQgZnVsbERhdGUgPSBtb21lbnQoZGF0ZSlcbiAgICAgICAgICAgIGxldCBmb3JtYXRTdHJpbmcgPSBmdWxsRGF0ZS5mb3JtYXQobG9zZUZvcm1hdClcblxuICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoY29tcG9uZW50LCBudWxsLCBmb3JtYXRTdHJpbmcpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgc2Vjb25kcyA9IE1hdGgucm91bmQoTWF0aC5hYnMobm93IC0gdGhlbikgLyAxMDAwKVxuICAgICAgICAgICAgbGV0IHN1ZmZpeCA9IHRoZW4gPCBub3cgPyBsYWJlbC5hZ28gOiBsYWJlbC5mcm9tTm93XG4gICAgICAgICAgICBsZXQgdmFsdWU6bnVtYmVyLCB1bml0OnN0cmluZ1xuXG4gICAgICAgICAgICBpZiAoc2Vjb25kcyA8IDYwKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBNYXRoLnJvdW5kKHNlY29uZHMpXG4gICAgICAgICAgICAgICAgdW5pdCA9IGxhYmVsLnNlY29uZFxuICAgICAgICAgICAgfSBlbHNlIGlmIChzZWNvbmRzIDwgNjAgKiA2MCkge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gTWF0aC5yb3VuZChzZWNvbmRzIC8gNjApXG4gICAgICAgICAgICAgICAgdW5pdCA9IGxhYmVsLm1pbnV0ZVxuICAgICAgICAgICAgfSBlbHNlIGlmIChzZWNvbmRzIDwgNjAgKiA2MCAqIDI0KSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBNYXRoLnJvdW5kKHNlY29uZHMgLyAoNjAgKiA2MCkpXG4gICAgICAgICAgICAgICAgdW5pdCA9IGxhYmVsLmhvdXJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2Vjb25kcyA8IDYwICogNjAgKiAyNCAqIDcpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IE1hdGgucm91bmQoc2Vjb25kcyAvICg2MCAqIDYwICogMjQpKVxuICAgICAgICAgICAgICAgIHVuaXQgPSBsYWJlbC5kYXlcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2Vjb25kcyA8IDYwICogNjAgKiAyNCAqIDMwKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBNYXRoLnJvdW5kKHNlY29uZHMgLyAoNjAgKiA2MCAqIDI0ICogNykpXG4gICAgICAgICAgICAgICAgdW5pdCA9IGxhYmVsLndlZWtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2Vjb25kcyA8IDYwICogNjAgKiAyNCAqIDM2NSkge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gTWF0aC5yb3VuZChzZWNvbmRzIC8gKDYwICogNjAgKiAyNCAqIDMwKSlcbiAgICAgICAgICAgICAgICB1bml0ID0gbGFiZWwubW9udGhcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBNYXRoLnJvdW5kKHNlY29uZHMgLyAoNjAgKiA2MCAqIDI0ICogMzY1KSlcbiAgICAgICAgICAgICAgICB1bml0ID0gbGFiZWwueWVhclxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZnVsbERhdGUgPSBtb21lbnQoZGF0ZSlcbiAgICAgICAgICAgIGxldCBuZXdQcm9wcyA9IE9iamVjdC5hc3NpZ24oe30sIG51bGwsIHtcbiAgICAgICAgICAgICAgICB0aXRsZTogZnVsbERhdGUuZm9ybWF0KGxvc2VGb3JtYXQpXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChjb21wb25lbnQsIG5ld1Byb3BzLCBmb3JtYXR0ZXIodmFsdWUsIHVuaXQsIHN1ZmZpeCwgdGhlbikpXG4gICAgICAgIH1cbiAgICB9XG59Il19